<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SafeAgentBench Architecture Diagrams</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:24px;line-height:1.4;color:#111;}
h1{font-size:28px;margin-bottom:12px;}
h2{font-size:20px;margin-top:28px;}
.img-wrap{margin:12px 0 24px 0;}
img{max-width:100%;height:auto;border:1px solid #e5e5e5;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.04);}
pre{background:#f7f7f7;padding:12px;border-radius:6px;overflow:auto;}
</style>
</head>
<body>
<h1>SafeAgentBench Architecture Diagrams</h1>
<h2>1) Text-Only Planning → Execution → Evaluation (Detailed Tasks)</h2>
<div class="img-wrap">
<img src="figure/architecture/01-text-only-planning.svg" alt="1) Text-Only Planning → Execution → Evaluation (Detailed Tasks)">
</div>
<pre>
sequenceDiagram
    autonumber
    participant User as User/Runner
    participant Dataset as Dataset (jsonl)
    participant Planner as LLM Planner
    participant Utils as methods/utils.py
    participant Env as SafeAgentEnv (AI2-THOR Controller)
    participant LL as LowLevelPlanner
    participant ExecEval as Execution Evaluator
    participant SemEval as Semantic Evaluator

    User-&gt;&gt;Dataset: Load task (instruction, scene, goal, ref steps)
    User-&gt;&gt;Env: Controller(scene)
    User-&gt;&gt;Planner: Generate high-level plan from instruction
    Planner--&gt;&gt;User: High-level plan
    User-&gt;&gt;Utils: gen_low_level_plan(plan)
    Utils--&gt;&gt;User: Low-level plan
    User-&gt;&gt;LL: execute_low_level_plan(low_level_plan)
    LL-&gt;&gt;Env: step(action) x N
    Env--&gt;&gt;LL: last_event metadata
    LL--&gt;&gt;User: execution results
    User-&gt;&gt;ExecEval: compute_SR_object_state(env_state, goal_state)
    ExecEval--&gt;&gt;User: success_rate, avg_success_ratio
    User-&gt;&gt;SemEval: compute_SR_llm(task, plan, ref_plan)
    SemEval--&gt;&gt;User: LLM judgment (success/fail)
</pre>
<h2>2) Vision-Based Planning Path (Figure 3 in the Paper)</h2>
<div class="img-wrap">
<img src="figure/architecture/02-vision-planning.svg" alt="2) Vision-Based Planning Path (Figure 3 in the Paper)">
</div>
<pre>
sequenceDiagram
    autonumber
    participant Runner as methods/vision_eval.py
    participant Env as SafeAgentEnv (AI2-THOR Controller)
    participant Vision as methods/map_vlm.py
    participant OpenAI as OpenAI Vision API
    participant Utils as methods/utils.py
    participant LL as LowLevelPlanner
    participant ExecEval as Execution Evaluator
    participant SemEval as Semantic Evaluator

    Runner-&gt;&gt;Env: Controller(scene)
    Env--&gt;&gt;Runner: last_event.frame (RGB)
    Runner-&gt;&gt;Vision: Agents(img, instruction)
    Vision-&gt;&gt;OpenAI: multi_agent_vision_planning(image + task)
    OpenAI--&gt;&gt;Vision: vision-based plan
    Vision--&gt;&gt;Runner: plan text
    Runner-&gt;&gt;Utils: gen_low_level_plan(plan)
    Utils--&gt;&gt;Runner: low-level plan
    Runner-&gt;&gt;LL: execute_low_level_plan(low_level_plan)
    LL-&gt;&gt;Env: step(action) x N
    Env--&gt;&gt;LL: last_event metadata
    LL--&gt;&gt;Runner: execution results
    Runner-&gt;&gt;ExecEval: compute_SR_object_state(env_state, goal_state)
    ExecEval--&gt;&gt;Runner: success_rate, avg_success_ratio
    Runner-&gt;&gt;SemEval: compute_SR_llm(task, plan, ref_plan)
    SemEval--&gt;&gt;Runner: LLM judgment (success/fail)
</pre>
<h2>3) Low-Level Controller Action Mapping</h2>
<div class="img-wrap">
<img src="figure/architecture/03-low-level-controller.svg" alt="3) Low-Level Controller Action Mapping">
</div>
<pre>
sequenceDiagram
    autonumber
    participant Planner as LowLevelPlanner
    participant Env as AI2-THOR Controller
    participant World as Simulated World

    Planner-&gt;&gt;Planner: parse instruction (e.g., "open microwave")
    Planner-&gt;&gt;Env: step(OpenObject, objectId)
    Env-&gt;&gt;World: apply physics + action
    World--&gt;&gt;Env: new state
    Env--&gt;&gt;Planner: last_event metadata
    Planner--&gt;&gt;Planner: success/failure + errorMessage
</pre>
<h2>4) Execution Evaluator (Object-State Check)</h2>
<div class="img-wrap">
<img src="figure/architecture/04-execution-evaluator.svg" alt="4) Execution Evaluator (Object-State Check)">
</div>
<pre>
sequenceDiagram
    autonumber
    participant Eval as evaluator/detail_evaluate.py
    participant Env as AI2-THOR Controller
    participant Goal as Goal Conditions

    Eval-&gt;&gt;Env: read last_event.metadata["objects"]
    Eval-&gt;&gt;Goal: compare objectType + properties
    Goal--&gt;&gt;Eval: per-object match ratios
    Eval--&gt;&gt;Eval: success_rate + avg_success_ratio
</pre>
<h2>5) Semantic Evaluator (LLM Plan Feasibility)</h2>
<div class="img-wrap">
<img src="figure/architecture/05-semantic-evaluator.svg" alt="5) Semantic Evaluator (LLM Plan Feasibility)">
</div>
<pre>
sequenceDiagram
    autonumber
    participant Eval as evaluator/detail_evaluate.py
    participant OpenAI as OpenAI API

    Eval-&gt;&gt;OpenAI: task + plan + ref plan + rules
    OpenAI--&gt;&gt;Eval: rating (success/fail) + explanation
</pre>
<h2>6) Long-Horizon Safety Evaluation (Implicit Hazards)</h2>
<div class="img-wrap">
<img src="figure/architecture/06-long-horizon-safety.svg" alt="6) Long-Horizon Safety Evaluation (Implicit Hazards)">
</div>
<pre>
sequenceDiagram
    autonumber
    participant Eval as evaluator/long_horizon_evaluate.py
    participant OpenAI as OpenAI API

    Eval-&gt;&gt;OpenAI: task + plan + safety requirements
    OpenAI--&gt;&gt;Eval: rating (Completed and safe / Completed but unsafe / Incomplete)
</pre>
<h2>7) OpenAI Call with Retry (Backoff Wrapper)</h2>
<div class="img-wrap">
<img src="figure/architecture/07-openai-retry.svg" alt="7) OpenAI Call with Retry (Backoff Wrapper)">
</div>
<pre>
sequenceDiagram
    autonumber
    participant Caller as methods/utils.py
    participant OpenAI as OpenAI API

    loop retry_with_exponential_backoff
        Caller-&gt;&gt;OpenAI: chat.completions.create(...)
        alt success
            OpenAI--&gt;&gt;Caller: response
        else transient error
            OpenAI--&gt;&gt;Caller: error
            Caller-&gt;&gt;Caller: sleep(backoff)
        end
    end
</pre>
<h2>Notes</h2>
</body></html>